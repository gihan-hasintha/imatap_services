<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Client Account</title>
    <!-- Modern CSS Framework (Bootstrap) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        .cropper-container {
            max-width: 100%;
        }
        .img-preview {
            overflow: hidden;
            width: 200px;
            height: 200px;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            background: #f8f9fa;
        }
        .tab-content {
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Create Client Account</h2>
                        <ul class="nav nav-tabs" id="photoTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="avatar-tab" data-bs-toggle="tab" data-bs-target="#avatarTabPane" type="button" role="tab">Profile Photo</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cover-tab" data-bs-toggle="tab" data-bs-target="#coverTabPane" type="button" role="tab">Cover Photo</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="photoTabContent">
                            <div class="tab-pane fade show active" id="avatarTabPane" role="tabpanel">
                                <label class="form-label mt-3">Avatar Image (Square):
                                    <input type="file" class="form-control" id="avatar" accept="image/*" required>
                                </label>
                                <div class="img-preview mb-2" id="avatarPreview"></div>
                                <button type="button" class="btn btn-outline-primary mb-3" id="cropAvatarBtn" disabled>Crop & Preview</button>
                            </div>
                            <div class="tab-pane fade" id="coverTabPane" role="tabpanel">
                                <label class="form-label mt-3">Cover Photo (16:9):
                                    <input type="file" class="form-control" id="coverPhoto" accept="image/*" required>
                                </label>
                                <div class="img-preview mb-2" id="coverPreview"></div>
                                <button type="button" class="btn btn-outline-primary mb-3" id="cropCoverBtn" disabled>Crop & Preview</button>
                            </div>
                        </div>
                        <form id="clientForm">
                            <div class="mb-3">
                                <label class="form-label">Gallery Photos (up to 4):</label>
                                <input type="file" class="form-control" id="galleryPhotos" accept="image/*" multiple>
                                <div class="d-flex flex-wrap mt-2" id="galleryPreview"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name: <input type="text" class="form-control" id="fullName" required></label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email: <input type="email" class="form-control" id="email" required></label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Job Role: <input type="text" class="form-control" id="jobRole" required></label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Company: <input type="text" class="form-control" id="company" required></label>
                                </div>
                            </div>
                            <div id="experienceContainer"></div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="addExperienceBtn">Add More Experience</button>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Phone: <input type="text" class="form-control" id="phone" required></label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Whatsapp Number: <input type="text" class="form-control" id="whatsapp" required></label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Business Phone: <input type="text" class="form-control" id="business_phone" required></label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Address: <input type="text" class="form-control" id="address" required></label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">School: <input type="text" class="form-control" id="school" required></label>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Website (optional): <input type="url" class="form-control" id="website"></label>
                                </div>
                            </div>
                            <fieldset class="mt-3">
                                <legend>Social Media Links (optional)</legend>
                                <div class="row">
                                    <div class="col-md-6" id="facebookContainer">
                                        <label class="form-label">Facebook:
                                            <input type="url" class="form-control facebook-input" name="facebook">
                                            <input type="text" class="form-control facebook-label-input mt-1" name="facebookLabel" placeholder="Description (e.g. personal, business page)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addFacebookBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="instagramContainer">
                                        <label class="form-label">Instagram:
                                            <input type="url" class="form-control instagram-input" name="instagram">
                                            <input type="text" class="form-control instagram-label-input mt-1" name="instagramLabel" placeholder="Description (e.g. personal, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addInstagramBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="tiktokContainer">
                                        <label class="form-label">TikTok:
                                            <input type="url" class="form-control tiktok-input" name="tiktok">
                                            <input type="text" class="form-control tiktok-label-input mt-1" name="tiktokLabel" placeholder="Description (e.g. personal, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addTikTokBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="linkedinContainer">
                                        <label class="form-label">LinkedIn:
                                            <input type="url" class="form-control linkedin-input" name="linkedin">
                                            <input type="text" class="form-control linkedin-label-input mt-1" name="linkedinLabel" placeholder="Description (e.g. personal, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addLinkedInBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="twitterContainer">
                                        <label class="form-label">X (Twitter):
                                            <input type="url" class="form-control twitter-input" name="twitter">
                                            <input type="text" class="form-control twitter-label-input mt-1" name="twitterLabel" placeholder="Description (e.g. personal, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addTwitterBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="youtubeContainer">
                                        <label class="form-label">YouTube:
                                            <input type="url" class="form-control youtube-input" name="youtube">
                                            <input type="text" class="form-control youtube-label-input mt-1" name="youtubeLabel" placeholder="Description (e.g. channel, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addYouTubeBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="behanceContainer">
                                        <label class="form-label">Behance:
                                            <input type="url" class="form-control behance-input" name="behance">
                                            <input type="text" class="form-control behance-label-input mt-1" name="behanceLabel" placeholder="Description (e.g. portfolio, business)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addBehanceBtn">Add More</button>
                                    </div>
                                    <div class="col-md-6" id="githubContainer">
                                        <label class="form-label">GitHub:
                                            <input type="url" class="form-control github-input" name="github">
                                            <input type="text" class="form-control github-label-input mt-1" name="githubLabel" placeholder="Description (e.g. personal, work)">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addGitHubBtn">Add More</button>
                                    </div>
                                </div>
                            </fieldset>
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">Create Account</button>
                            </div>
                        </form>
                        <div id="status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAjv12MJilOWARxoe_YqEXB9YZ2i1QMTd0",
            authDomain: "imatap.firebaseapp.com",
            projectId: "imatap",
            storageBucket: "imatap.firebasestorage.app",
            messagingSenderId: "385083217755",
            appId: "1:385083217755:web:83334c40989a9032c8ac7e",
            measurementId: "G-43CKB8XJBF"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Cloudinary config (replace with your own)
        const cloudName = 'dffhwv0m1'; // TODO: Replace
        const unsignedUploadPreset = 'avatars'; // TODO: Replace

        let avatarCropper, coverCropper, avatarBlob, coverBlob;

        // Avatar Cropper
        document.getElementById('avatar').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = document.createElement('img');
                img.src = evt.target.result;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '300px';
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = '';
                preview.appendChild(img);
                if (avatarCropper) avatarCropper.destroy();
                avatarCropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    scalable: true,
                    cropBoxResizable: true
                });
                document.getElementById('cropAvatarBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('cropAvatarBtn').addEventListener('click', function() {
            if (!avatarCropper) return;
            avatarCropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(function(blob) {
                avatarBlob = blob;
                // Show preview
                const url = URL.createObjectURL(blob);
                document.getElementById('avatarPreview').innerHTML = `<img src="${url}" style="width:100%;max-width:200px;">`;
            }, 'image/webp');
        });

        // Cover Cropper
        document.getElementById('coverPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = document.createElement('img');
                img.src = evt.target.result;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '300px';
                const preview = document.getElementById('coverPreview');
                preview.innerHTML = '';
                preview.appendChild(img);
                if (coverCropper) coverCropper.destroy();
                coverCropper = new Cropper(img, {
                    aspectRatio: 16/9,
                    viewMode: 1,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    scalable: true,
                    cropBoxResizable: true
                });
                document.getElementById('cropCoverBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('cropCoverBtn').addEventListener('click', function() {
            if (!coverCropper) return;
            coverCropper.getCroppedCanvas({ width: 1280, height: 720 }).toBlob(function(blob) {
                coverBlob = blob;
                // Show preview
                const url = URL.createObjectURL(blob);
                document.getElementById('coverPreview').innerHTML = `<img src="${url}" style="width:100%;max-width:300px;">`;
            }, 'image/webp');
        });

        // Add dynamic add-more logic for all social media
        const addMoreConfigs = [
            { btn: 'addFacebookBtn', container: 'facebookContainer', className: 'facebook-input', labelClass: 'facebook-label-input', placeholder: 'Additional Facebook URL', labelPlaceholder: 'Description (e.g. personal, business page)' },
            { btn: 'addInstagramBtn', container: 'instagramContainer', className: 'instagram-input', labelClass: 'instagram-label-input', placeholder: 'Additional Instagram URL', labelPlaceholder: 'Description (e.g. personal, business)' },
            { btn: 'addTikTokBtn', container: 'tiktokContainer', className: 'tiktok-input', labelClass: 'tiktok-label-input', placeholder: 'Additional TikTok URL', labelPlaceholder: 'Description (e.g. personal, business)' },
            { btn: 'addLinkedInBtn', container: 'linkedinContainer', className: 'linkedin-input', labelClass: 'linkedin-label-input', placeholder: 'Additional LinkedIn URL', labelPlaceholder: 'Description (e.g. personal, business)' },
            { btn: 'addTwitterBtn', container: 'twitterContainer', className: 'twitter-input', labelClass: 'twitter-label-input', placeholder: 'Additional Twitter URL', labelPlaceholder: 'Description (e.g. personal, business)' },
            { btn: 'addYouTubeBtn', container: 'youtubeContainer', className: 'youtube-input', labelClass: 'youtube-label-input', placeholder: 'Additional YouTube URL', labelPlaceholder: 'Description (e.g. channel, business)' },
            { btn: 'addBehanceBtn', container: 'behanceContainer', className: 'behance-input', labelClass: 'behance-label-input', placeholder: 'Additional Behance URL', labelPlaceholder: 'Description (e.g. portfolio, business)' },
            { btn: 'addGitHubBtn', container: 'githubContainer', className: 'github-input', labelClass: 'github-label-input', placeholder: 'Additional GitHub URL', labelPlaceholder: 'Description (e.g. personal, work)' }
        ];
        addMoreConfigs.forEach(cfg => {
            document.getElementById(cfg.btn).addEventListener('click', function() {
                const wrapper = document.createElement('div');
                wrapper.className = 'mt-2';
                const newInput = document.createElement('input');
                newInput.type = 'url';
                newInput.className = 'form-control ' + cfg.className;
                newInput.name = cfg.className.replace('-input', '');
                newInput.placeholder = cfg.placeholder;
                const newLabelInput = document.createElement('input');
                newLabelInput.type = 'text';
                newLabelInput.className = 'form-control mt-1 ' + cfg.labelClass;
                newLabelInput.name = cfg.labelClass.replace('-label-input', 'Label');
                newLabelInput.placeholder = cfg.labelPlaceholder;
                wrapper.appendChild(newInput);
                wrapper.appendChild(newLabelInput);
                document.getElementById(cfg.container).appendChild(wrapper);
            });
        });

        document.getElementById('addExperienceBtn').addEventListener('click', function() {
            const container = document.getElementById('experienceContainer');
            const row = document.createElement('div');
            row.className = 'row mt-2';
            row.innerHTML = `
                <div class="col-md-6">
                    <input type="text" class="form-control exp-company" placeholder="Company Name" required>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control exp-jobrole" placeholder="Job Role" required>
                </div>
            `;
            container.appendChild(row);
        });

        let galleryFiles = [];
        let galleryDataUrls = [];

        document.getElementById('galleryPhotos').addEventListener('change', function(e) {
            const files = Array.from(e.target.files).slice(0, 4 - galleryFiles.length); // Only allow up to 4
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    galleryFiles.push(file);
                    galleryDataUrls.push(evt.target.result);
                    renderGalleryPreview();
                };
                reader.readAsDataURL(file);
            });
            // Reset the input so the same file can be selected again if removed
            e.target.value = '';
        });

        function renderGalleryPreview() {
            const preview = document.getElementById('galleryPreview');
            preview.innerHTML = '';
            galleryDataUrls.forEach((dataUrl, idx) => {
                const card = document.createElement('div');
                card.className = 'card me-2 mb-2';
                card.style.width = '120px';
                card.innerHTML = `
                    <img src="${dataUrl}" class="card-img-top" style="height:80px;object-fit:cover;">
                    <div class="card-body p-2">
                        <button type="button" class="btn btn-sm btn-danger w-100" data-idx="${idx}">Remove</button>
                    </div>
                `;
                preview.appendChild(card);
            });

            // Add remove event listeners
            preview.querySelectorAll('button[data-idx]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-idx'));
                    galleryFiles.splice(idx, 1);
                    galleryDataUrls.splice(idx, 1);
                    renderGalleryPreview();
                });
            });
        }

        function dataUrlToWebpBlob(dataUrl, maxWidth = 800, maxHeight = 800) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    // Resize if needed
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth || height > maxHeight) {
                        const scale = Math.min(maxWidth / width, maxHeight / height);
                        width = width * scale;
                        height = height * scale;
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/webp', 0.92);
                };
                img.src = dataUrl;
            });
        }

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Uploading avatar...';
            // Upload avatar to Cloudinary
            if (!avatarBlob) {
                statusDiv.textContent = 'Please crop and preview the avatar image.';
                return;
            }
            if (!coverBlob) {
                statusDiv.textContent = 'Please crop and preview the cover photo.';
                return;
            }
            const avatarFormData = new FormData();
            avatarFormData.append('file', avatarBlob, 'avatar.webp');
            avatarFormData.append('upload_preset', unsignedUploadPreset);
            let cloudinaryData, coverPhotoUrl = '';
            try {
                const cloudinaryRes = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: avatarFormData
                });
                cloudinaryData = await cloudinaryRes.json();
                if (!cloudinaryData.secure_url) throw new Error('Cloudinary upload failed');
                // Upload cover photo
                statusDiv.textContent = 'Uploading cover photo...';
                const coverFormData = new FormData();
                coverFormData.append('file', coverBlob, 'cover.webp');
                coverFormData.append('upload_preset', unsignedUploadPreset);
                const coverRes = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: coverFormData
                });
                const coverData = await coverRes.json();
                if (!coverData.secure_url) throw new Error('Cover photo upload failed');
                coverPhotoUrl = coverData.secure_url;
                statusDiv.textContent = 'Uploading gallery photos...';
                let galleryUrls = [];
                for (let i = 0; i < galleryDataUrls.length; i++) {
                    if (!galleryDataUrls[i]) continue;
                    const webpBlob = await dataUrlToWebpBlob(galleryDataUrls[i]);
                    const formData = new FormData();
                    formData.append('file', webpBlob, 'gallery' + (i+1) + '.webp');
                    formData.append('upload_preset', unsignedUploadPreset);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (!data.secure_url) throw new Error('Gallery photo upload failed');
                    galleryUrls.push(data.secure_url);
                }
                statusDiv.textContent = 'Saving data to Firestore...';
                // Collect all social media inputs as arrays of objects
                function collectSocialArray(urlClass, labelClass) {
                    const urls = document.querySelectorAll('.' + urlClass);
                    const labels = document.querySelectorAll('.' + labelClass);
                    const arr = [];
                    for (let i = 0; i < urls.length; i++) {
                        if (urls[i].value) {
                            arr.push({ url: urls[i].value, label: labels[i] ? labels[i].value : '' });
                        }
                    }
                    return arr;
                }
                const facebookArray = collectSocialArray('facebook-input', 'facebook-label-input');
                const instagramArray = collectSocialArray('instagram-input', 'instagram-label-input');
                const tiktokArray = collectSocialArray('tiktok-input', 'tiktok-label-input');
                const linkedinArray = collectSocialArray('linkedin-input', 'linkedin-label-input');
                const twitterArray = collectSocialArray('twitter-input', 'twitter-label-input');
                const youtubeArray = collectSocialArray('youtube-input', 'youtube-label-input');
                const behanceArray = collectSocialArray('behance-input', 'behance-label-input');
                const githubArray = collectSocialArray('github-input', 'github-label-input');

                // Collect all working experiences
                const experiences = [];
                // Add the original fields
                const mainCompany = document.getElementById('company').value;
                const mainJobRole = document.getElementById('jobRole').value;
                if (mainCompany && mainJobRole) {
                    experiences.push({ company: mainCompany, jobRole: mainJobRole });
                }
                // Add dynamically added experiences
                const expCompanies = document.querySelectorAll('.exp-company');
                const expJobRoles = document.querySelectorAll('.exp-jobrole');
                for (let i = 0; i < expCompanies.length; i++) {
                    if (expCompanies[i].value && expJobRoles[i].value) {
                        experiences.push({ company: expCompanies[i].value, jobRole: expJobRoles[i].value });
                    }
                }

                const data = {
                    avatarUrl: cloudinaryData.secure_url,
                    coverPhotoUrl: coverPhotoUrl,
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    jobRole: document.getElementById('jobRole').value,
                    company: document.getElementById('company').value,
                    phone: document.getElementById('phone').value,
                    businessPhone: document.getElementById('business_phone').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    address: document.getElementById('address').value,
                    school: document.getElementById('school').value,
                    website: document.getElementById('website').value,
                    social: {
                        facebook: facebookArray,
                        instagram: instagramArray,
                        tiktok: tiktokArray,
                        linkedin: linkedinArray,
                        twitter: twitterArray,
                        youtube: youtubeArray,
                        behance: behanceArray,
                        github: githubArray
                    },
                    experiences: experiences
                };
                const docRef = await addDoc(collection(db, 'clients'), data);
                statusDiv.innerHTML = 'Client account created successfully!<br><a href="account.html?id=' + docRef.id + '">View Account</a>';
                document.getElementById('clientForm').reset();
                document.getElementById('avatarPreview').innerHTML = '';
                document.getElementById('coverPreview').innerHTML = '';
                avatarBlob = null;
                coverBlob = null;
                document.getElementById('cropAvatarBtn').disabled = true;
                document.getElementById('cropCoverBtn').disabled = true;
                document.getElementById('galleryPhotos').value = '';
                galleryFiles = [];
                galleryDataUrls = [];
                renderGalleryPreview();
            } catch (err) {
                statusDiv.textContent = 'Error: ' + err.message;
            }
        });
    </script>
</body>
</html>